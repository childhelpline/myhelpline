{% load i18n %}
{% load staticfiles %}
<!-- {% load notifications_tags %} -->
{% load humanize %}
{% load crispy_forms_tags %}
{% load avatar_tags %}
{% load dboard_tags %}
{% notifications_unread as unread_count %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>{% block helpline_title %}Helpline{% endblock %}</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="{% static "bootstrap/dist/css/bootstrap.min.css" %}">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{% static "font-awesome/css/font-awesome.min.css" %}">
  <!-- Ionicons -->
  <link rel="stylesheet" href="{% static "Ionicons/css/ionicons.min.css" %}">
  <!-- jvectormap -->
  <link rel="stylesheet" href="{% static "AdminLTE/plugins/jvectormap/jquery-jvectormap-1.2.2.css" %}">
  <!-- Theme style -->
  <link rel="stylesheet" href="{% static "AdminLTE/dist/css/AdminLTE.min.css" %}">
  <!-- DataTables -->
  <link rel="stylesheet" href="{% static "AdminLTE/plugins/datatables/dataTables.bootstrap.css" %}">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
   folder instead of downloading all of them to reduce the load. -->
   <link rel="stylesheet" href="{% static "AdminLTE/dist/css/skins/_all-skins.min.css" %}">

   <link rel="stylesheet" href="{% static "helpline/css/style.css" %}">
   <!-- <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
  </script> -->

   <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
   <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
{% block additional-headers %}{% endblock %}
<!-- jQuery 2.2.3 TEST-->
<script src="{% static "jquery/dist/jquery.min.js" %}"></script>
<script type="text/javascript" src="/jsi18n/"></script>
<script src="{% static 'clipboard/dist/clipboard.min.js' %}" type="text/javascript"></script>
<script type="text/javascript" src="{% static 'helpline/js/codedance/jquery.are-you-sure.js' %}"></script></head>
<script type="text/javascript">
  let params = new URLSearchParams(location.search);
</script>

{% block head %}{% endblock head %}
<style type="text/css">

/* The switch - the box around the slider */
.switch {
  position: relative;
  display: inline-block;
  width: 40px;
  height: 24px;
}
/* Hide default HTML checkbox */
.switch input {display:none;}

/* The slider */
.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}
input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(16px);
  -ms-transform: translateX(16px);
  transform: translateX(16px);
}
/* Rounded sliders */
.slider.round {
  border-radius: 28px;
}

.slider.round:before {
  border-radius: 50%;
}
.ml-0{
  margin-left: 0px !important;
}
.iw img{
  width: auto !important;
  border-radius: 50%;
  border: solid 0.2em #eee;
}

.errorlist{
  padding: 2px 5px;
  border: solid thin red;
  border-radius: 5px;
  list-style:square;
}
.errorlist li{
  color: orange;
  margin-left: 20px;
}
</style>

<body class="hold-transition skin-blue sidebar-mini fixed">
  <div class="wrapper">

    <header class="main-header">

      <!-- Logo -->
      <a href="{% url "dashboard_home" %}" class="logo">
        <!-- mini logo for sidebar mini 50x50 pixels -->
        <span class="logo-mini"><b>H</b>L</span>
        <!-- logo for regular state and mobile devices -->
        <span class="logo-lg"><b>HELPLINE</b></span>
      </a>

      <!-- Header Navbar: style can be found in header.less -->
      <nav class="navbar navbar-static-top">
        <!-- Sidebar toggle button-->
        <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
          <span class="sr-only">Toggle navigation</span>
        </a>
        <!-- Navbar Right Menu -->
        <div class="navbar-custom-menu">
          <ul class="nav navbar-nav">
            <!-- Messages: style can be found in dropdown.less-->
            {% if request.user.HelplineUser.hl_role == 'Supervisor' or request.user.HelplineUser.hl_role == 'Counsellor' or request.user.HelplineUser.hl_role == 'Casemanager' %}

            <li class="dropdown messages-menu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <i class="fa fa-bookmark"></i>{% trans "Average Talk Time" %}: {{ call_stat.avgtalk }}
              </a>
            </li>
            <!-- Messages: style can be found in dropdown.less-->
            <li class="dropdown messages-menu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <i class="fa fa-bookmark"></i>{% trans "Average Wait Time" %}: {{ call_stat.avgwait }}
              </a>
            </li>

            <!-- Messages: style can be found in dropdown.less-->
            <li class="dropdown messages-menu">
               <a href="#" class="leave hidden" onclick="leave_queue(this)" data-toggle="dropdown">
                <i class="fa fa-phone"></i>{% trans "Leave Queue" %}
              </a>
              <a href="#" class="dropdown-toggle join" onclick="join_queue(this)" data-toggle="dropdown">
                <i class="fa fa-phone"></i>{% trans "Join Queue" %}
              </a>
            </li>
            {% endif %}

            <!-- Messages: style can be found in dropdown.less-->
            <li class="dropdown messages-menu">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                <i class="fa fa-clock-o"></i>  <span id="clock">0:00 AM</span>
              </a>
              <!-- <ul class="dropdown-menu">
                <li class="header">
                  {% if request.user.HelplineUser.hl_status == 'Busy' %}
                  <a href="{% url 'queue_log' %}"><i class="fa fa-circle text-danger"></i> {% trans "Busy" %}</a>
                  {% elif request.user.HelplineUser.hl_status == 'Idle' %}
                  <a href="{% url 'queue_log' %}"><i class="fa fa-exclamation-triangle text-warning"></i> {% trans "Idle" %}</a>
                  {% elif request.user.HelplineUser.hl_status == 'Available' %}
                  <a href="{% url 'queue_log' %}"><i class="fa fa-circle text-success"></i> {% trans "Online" %}</a>
                  {% elif request.user.HelplineUser.hl_status == 'OnCall' %}
                  <a href="{% url 'queue_log' %}"><i class="fa fa-circle text-danger"></i> {% trans "OnCall" %}</a>
                  {% endif %}
                  <span id="durations"></span>
                </li>
                <li class="footer">
                </li>
              </ul> -->
            </li>

          <!-- <li class="dropdown messages-menu">
           {% if request.user.HelplineUser.hl_status == 'Available' %}
           <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <i class="fa fa-pause"></i>{% trans "Break" %}
          </a>

          <ul class="dropdown-menu">
            <!-- Pause queue ->
            <form action="{% url 'queue_pause' %}" method="post">{% csrf_token %}
              {{ queue_pause_form }}
              <input type="submit" value="Go" />
            </form>
            <!-- Pause queue ->
          </ul>
          {% elif request.user.HelplineUser.hl_status == 'Pause' %}
          <a href="{% url 'queue_unpause' %}">
            <i class="fa fa-play"></i>{% trans "Continue" %}
          </a>
          {% endif %} 
        </li>-->


        <!-- Notifications: style can be found in dropdown.less -->
        <li class="dropdown notifications-menu">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <i class="fa fa-comment-o"></i>
            {% live_notify_badge badge_class="label label-warning" %}
          </a>
          <ul class="dropdown-menu">
            <li class="header">{% blocktrans %}You have {{ unread_count }} notification{{ unread_count|pluralize }}{% endblocktrans %}</li>
            <li>
              <!-- inner menu: contains the actual data -->
              {% live_notify_list list_class="dropdown-menu" %}
            </li>
            <li class="footer"><a href="{% url "notifications:unread" %}">View all</a></li>
          </ul>
        </li>


        <!-- Notifications: style can be found in dropdown.less -->
        <li class="dropdown notifications-menu">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <i class="fa fa-envelope-o"></i>
            {% live_notify_badge badge_class="label label-warning" %}
          </a>
          <ul class="dropdown-menu">
            <li class="header">{% blocktrans %}You have {{ unread_count }} notification{{ unread_count|pluralize }}{% endblocktrans %}</li>
            <li>
              <!-- inner menu: contains the actual data -->
              {% live_notify_list list_class="dropdown-menu" %}
            </li>
            <li class="footer"><a href="{% url "notifications:unread" %}">View all</a></li>
          </ul>
        </li>
        <li class="dropdown notifications-menu">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <i class="fa fa-language"></i>
          </a>
          <ul class="dropdown-menu">
            <!-- Language selection -->
            <form action="{% url 'set_language' %}" method="post">{% csrf_token %}
              <input name="next" type="hidden" value="{{ redirect_to }}" />
              <select name="language">
                {% get_current_language as LANGUAGE_CODE %}
                {% get_available_languages as LANGUAGES %}
                {% get_language_info_list for LANGUAGES as languages %}
                {% for language in languages %}
                <option value="{{ language.code }}"{% if language.code == LANGUAGE_CODE %} selected{% endif %} >
                  {{ language.name_local }} ({{ language.code }})
                </option>
                {% endfor %}
              </select>
              <input type="submit" value="Go" />
            </form>
            <!-- Language selection -->
          </ul>

        </li>

        <!-- User Account: style can be found in dropdown.less -->
        <li class="dropdown user user-menu">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            <img src="{{request.user.HelplineUser.hl_avatar  | default:'/media/blank-avatar.png'}}" alt="{{request.user.HelplineUser.hl_avatar}}" class="user-image" /> 
            <!-- {% avatar request.user.avatar 160 class="user-image" %} -->
            <span class="hiddenen-xs">{{ request.user.get_full_name|default:request.user.username }}</span>
          </a>
          <ul class="dropdown-menu">
            <!-- User image -->
            <li class="user-header">
              <!-- {% avatar user 160 class="img-circle" %} -->
              <img src="{{request.user.HelplineUser.hl_avatar | default:'/media/blank-avatar.png'}}" alt="{{request.user.HelplineUser.hl_avatar}}" class="img-circle" /> 

              <p>
               {{ request.user.get_full_name|default:request.user.username }}
               <small>{% trans "Member Since" %}, {{ request.user.date_joined|date:"M Y" }}</small>
             </p>
           </li>
           <!-- Menu Body -->
           <li class="user-body">
            <div class="row">
              <div class="col-xs-4 text-center">
                <!-- <a href="{% url "admin:index" %}">Admin</a> -->
                <a href="#" class="btn btn-sm btn-primary" data-backdrop="static" data-toggle="modal" data-target="#pss-modal"> Update Password</a>
              </div>
            </div>
<!-- /.row -->
</li>
<!-- Menu Footer-->
<li class="user-footer">
  <div class="pull-left">
    <a href="{% url 'manageusers' 'edit' user.HelplineUser.hl_key %}" class="btn btn-default btn-flat">Profile</a>
  </div>
  <div class="pull-right">
    <a href="{% url 'logout' %}" onclick="leave_queue(this)" class="btn btn-default btn-flat">Sign out</a>
  </div>
</li>
</ul>
</li>
<!-- Control Sidebar Toggle Button -->
<li>
  <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
</li>
</ul>
</div>

</nav>
</header>
<!-- Left side column. contains the logo and sidebar -->
<aside class="main-sidebar">
  <!-- sidebar: style can be found in sidebar.less -->
  <section class="sidebar">
    <!-- Sidebar user panel -->
    <div class="user-panel">
      <div class="pull-left image">
         <img src="{{request.user.HelplineUser.hl_avatar | default:'/media/blank-avatar.png'}}" alt="{{request.user.username}}" class="img-circle" /> <!-- {% avatar user 160 class="img-circle" %} -->
      </div>
      <div class="pull-left info">
        <p>{{ request.user.get_full_name|default:request.user.username }}</p>
        <p><small><em>{{ request.user.HelplineUser.hl_status|default:'' }}</em></small></p>
        {% if request.user.HelplineUser.hl_status == 'Busy' %}
        <a href="{% url 'queue_log' %}"><i class="fa fa-circle text-danger"></i> {% trans "Busy" %}</a>
        {% elif request.user.HelplineUser.hl_status == 'Idle' %}
        <a href="{% url 'queue_log' %}"><i class="fa fa-circle text-warning"></i> {% trans "Idle" %}</a>
        {% elif request.user.HelplineUser.hl_status == 'Online' %}
        <a href="{% url 'queue_log' %}"><i class="fa fa-circle text-success"></i> {% trans "Online" %}</a>
        {% elif request.user.HelplineUser.hl_status == 'OnCall' %}
        <a href="{% url 'queue_log' %}"><i class="fa fa-circle text-danger"></i> {% trans "OnCall" %}</a>
        {% endif %}
      </div>
    </div>
    <!-- search form -->
    <form action="{% url 'dashboardreports' 'search' %}" method="get" class="sidebar-form">
      <div class="input-group">
        <input id="navbar-search-input" type="text" name="q" class="form-control" placeholder="{% trans "Search" %}..." value="{{ query }}">
        <span class="input-group-btn">
          <button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
          </button>
        </span>
      </div>
    </form>
    <!-- /.search form -->
    <!-- sidebar menu: : style can be found in sidebar.less -->
    <ul class="sidebar-menu">
      <li class="header">{% trans "MAIN NAVIGATION" %}</li>
      <li class="active">
        <a href="/helpline/">
          <i class="fa fa-dashboard"></i> <span>{% trans "Dashboard" %}</span>
        </a>
      </li>
      <li class="treeview">
        <a href="#">
          <i class="fa fa-files-o"></i>
          <span>{% trans "Cases" %}</span>
          <span class="pull-right-container">
            <i class="fa fa-angle-left pull-right"></i>
          </span>
        </a>
        <ul class="treeview-menu">
         <!--  <li>
            <a href="{% url "case_form" "webonline" %}" role="button"><i class="fa fa-circle-o"></i> {% trans "Web Online" %}
            </a></li> -->
            <li>
              <a href="{% url "case_form" "walkin" %}" role="button"><i class="fa fa-circle-o"></i> {% trans "New WalkIn" %}
              </a></li>

              {% if request.user.HelplineUser.hl_role == 'Casemanager'  or request.user.HelplineUser.hl_role == 'Caseworker' %}
              <li><a href="{% url 'dashboardreports' 'today' 'case' %}"><i class="fa fa-circle-o"></i> {% trans "My Walkin Cases" %}
                <span class="pull-right-container">
                  <span class="label label-success pull-right">{{ home.total }}</span>
                </span>
              </a></li>
              {% else %}
              <li><a href="{% url 'dashboardreports' 'today' 'case' %}"><i class="fa fa-circle-o"></i> {% trans "Today's Cases" %}
                <span class="pull-right-container">
                  <span class="label label-success pull-right">{{ home.total }}</span>
                </span>
              </a></li>
              {% endif %}
              <li><a href="{% url 'dashboardreports' 'escalated' 'case' %}"><i class="fa fa-circle-o"></i> {% trans "Escalated Cases" %}
                <span class="pull-right-container">
                  <span class="label label-warning pull-right">{{ home.escalate }}</span>
                </span>
              </a></li>

              {% if request.user.HelplineUser.hl_role == 'Casemanager' %}
              <li><a href="{% url 'dashboardreports' 'assigned' 'case' %}"><i class="fa fa-circle-o"></i> {% trans "Escalated Out Cases" %}
                <span class="pull-right-container">
                  <span class="label label-warning pull-right">{{ home.escalate }}</span>
                </span>
              </a></li>
              {% endif %}
              <!--li><a href="{% url 'dashboardreports' 'pendingcases' %}?datetime_range={{ dashboard_stats.midnight_string }} - {{ dashboard_stats.now_string }}"><i class="fa fa-circle-o"></i> {% trans "Pending Cases" %}
                <span class="pull-right-container">
                  <span class="label label-warning pull-right">{{ dashboard_stats.open_cases }}</span>
                </span>
              </a></li-->
              <li><a href="{% url 'dashboardreports' 'totalcases' 'case' %}"><i class="fa fa-circle-o"></i> {% trans "All Cases" %}
                <span class="pull-right-container">
                  <span class="label label-info pull-right">{{ home.total_submissions }}</span>
                </span>
              </a></li>
            </ul>
          </li>
          {% if request.user.HelplineUser.hl_role != 'Casemanager'  and request.user.HelplineUser.hl_role != 'Caseworker' %}
          <li class="treeview">
            <a href="#">
              <i class="fa fa-files-o"></i>
              <span>{% trans "Calls" %}</span>
              <span class="pull-right-container">
                <i class="fa fa-angle-left pull-right"></i>
              </span>
            </a>
            <ul class="treeview-menu">
              <li>
                <a href="{% url 'dashboardreports' 'missedcalls' %}">
                  <i class="fa fa-circle-o"></i> {% trans "Missed Calls" %}
                  <span class="pull-right-container">
                    <span class="label label-danger pull-right">{{ home.call_stat.abandoned }}</span>
                  </span>
                </a>
              </li>
              <li><a href="{% url 'dashboardreports' 'answeredcalls' %}"><i class="fa fa-circle-o"></i> {% trans "Answered Calls" %}
                <span class="pull-right-container">
                  <span class="label label-success pull-right">{{ home.call_stat.answered }}</span>
                </span>
              </a></li>
              <li><a href="{% url 'dashboardreports' 'voicemails' %}"><i class="fa fa-circle-o"></i> {% trans "Voice Mails" %}
                <span class="pull-right-container">
                  <span class="label label-warning pull-right">{{ home.call_stat.voicemail }}</span>
                </span>
              </a>
            </li>
              <li><a href="{% url 'dashboardreports' 'totalcalls' %}"><i class="fa fa-circle-o"></i> {% trans "All Calls" %}
                <span class="pull-right-container">
                  <span class="label label-info pull-right">{{ home.call_stat.calls }}</span>
                </span>
              </a>
            </li>
            </ul>
          </li>
          <!-- <li>
            <a href="http://159.89.21.204/mibew/index.php/operator">
              <i class="fa fa-comments"></i> <span>chat</span>
              <span class="pull-right-container">
                <small class="label pull-right bg-green" id="sms-notify-badge"></small>
              </span>
            </a>
          </li> -->
          
          <li class="treeview">
            <a href="javascript:void(0)">
              <i class="fa fa-pie-chart"></i> <span>{% trans "Sources" %}</span>
              <span class="pull-right-container">
                <i class="fa fa-angle-left pull-right"></i>
              </span>
            </a>
            <ul class="treeview-menu">
              <li>
                <a href="{% url 'mysources' 'safepal' %}">
                  <i class="fa fa-circle-o"></i>
                  <span>{% trans "Safepal" %}</span><span class="pull-right-container">
                  <span class="label label-info pull-right">{{ home.email }}</span>
                </span>
                </a>
              </li>
              <li>
                <a href="{% url 'mysources' 'email' %}">
                  <i class="fa fa-circle-o"></i>
                  <span>{% trans "Emails" %}</span><span class="pull-right-container">
                  <span class="label label-info pull-right">{{ home.email }}</span>
                </span>
                </a>
              </li>
              <li class="treeview">
                <a href="{% url 'mysources' 'sms' %}">
                  <i class="fa fa-circle-o"></i>
                  <span>{% trans "SMS" %}</span><span class="pull-right-container">
                  <span class="label label-success pull-right">{{ home.sms }}</span>
                </span>
                </a>
              </li>
              <li class="treeview">
                <a href="{% url 'mysources' 'web' %}">
                  <i class="fa fa-circle-o"></i>
                  <span>{% trans "Web Online" %}</span><span class="label label-success pull-right"></span>
                </a>
              </li>
              <!--li class="treeview">
                <a href="{% url 'mysources' 'twitter' %}">
                  <i class="fa fa-twitter"></i>
                  <span>{% trans "Twitter" %}</span><span class="label label-info pull-right"></span>
                </a>
              </li-->
            </ul>
          </li>
          {% endif %}
          {% if request.user.HelplineUser.hl_role == 'Supervisor' or  request.user.HelplineUser.is_superuser %}
          <li class="treeview" >
            <a href="#">
              <i class="fa fa-files-o"></i>
              <span>{% trans "QA" %}</span>
              <span class="pull-right-container">
                <i class="fa fa-angle-left pull-right"></i>
              </span>
            </a>
            <ul class="treeview-menu">
          <!--li>
            <a href="{% url "case_form" "qa" %}" role="button"><i class="fa fa-circle-o"></i> {% trans "New QA Form" %}
            </a></li ?datetime_range={{ dashboard_stats.midnight_string }} - {{ dashboard_stats.now_string }} -->
            <li><a href="{% url 'qa' 'analysis' %}"><i class="fa fa-circle-o"></i> {% trans "Call Cases" %}
              <span class="pull-right-container">
                <span class="label label-info pull-right">{{ home.total_cases }}</span>
              </span>
            </a></li>
            <li><a href="{% url 'qa' 'analysed' %}"><i class="fa fa-circle-o"></i> {% trans "Analysed Cases" %}
              <span class="pull-right-container">
                <span class="label label-success pull-right">{{ home.open_cases }}</span>
              </span>
            </a></li>
            <li><a href="{% url 'qa' 'results' %}"><i class="fa fa-circle-o"></i> {% trans "Qa Results" %}
              <span class="pull-right-container">
                <span class="label label-success pull-right"></span>
              </span>
            </a></li>
          </ul>
        </li>
        {% endif %}
        {% if request.user.HelplineUser.hl_role == 'Administrator'  or  request.user.is_superuser or request.user.HelplineUser.hl_role == 'Admin' %}

        <li>
          <a href="{% url 'manageusers' %}">
            <i class="fa fa-users"></i> <span>{% trans "Users" %}</span>
          </a>
        </li>
        <li>
          <a href="{% url 'user_profile' request.user.username %}">
            <i class="fa fa-wpforms"></i> <span>{% trans "Forms" %}</span>
          </a>
        </li>
        <li>
          <a href="{% url 'wall' %}">
            <i class="fa fa-tv"></i> <span>{% trans "Wall Board" %}</span>
          </a>
        </li>
        <!-- <li class="treeview">
          <a href="{% url 'adminreports' 'callsummaryreport' %}">
            <i class="fa fa-pie-chart"></i> <span>{% trans "Settings" %}</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li><a href="{% url 'dashboardreports' 'totalcalls' %}"><i class="fa fa-circle-o"></i>{% trans "Services" %}
            </a></li>
            <li><a href="{% url 'dashboardreports' 'answeredcalls' %}"><i class="fa fa-circle-o"></i>{% trans "Hot Desk" %}
            </a></li>
          </ul>
        </li> -->
        {% endif %}

        <li class="treeview {% block treeview_reports %}{% endblock treeview_reports %}">
          <a href="{% url 'adminreports' 'callsummaryreport' %}">
            <i class="fa fa-pie-chart"></i> <span>{% trans "Reports" %}</span>
            <span class="pull-right-container">
              <i class="fa fa-angle-left pull-right"></i>
            </span>
          </a>
          <ul class="treeview-menu">
            <li><a href="{% url 'general' 'cases' %}"><i class="fa fa-circle-o"></i>{% trans "Cases" %}
            </a></li>

            {% if request.user.HelplineUser.hl_role == 'Supervisor' or request.user.HelplineUser.hl_role == 'Administrator' or request.user.HelplineUser.hl_role == 'Admin' %}
            <li><a href="{% url 'pivot' %}"><i class="fa fa-circle-o"></i>{% trans "Pivot" %}
            </a></li>
            {% endif %}
            {% if request.user.HelplineUser.hl_role != 'Casemanager'  and request.user.HelplineUser.hl_role != 'Caseworker' %}
            <li><a href="{% url 'dashboardreports' 'totalcalls' %}"><i class="fa fa-circle-o"></i>{% trans "Calls" %}
            </a></li>
            <li><a href="{% url 'general' 'sms' %}"><i class="fa fa-circle-o"></i>{% trans "SMS" %}
            </a></li>
            <li><a href="{% url 'general' 'emails' %}"><i class="fa fa-circle-o"></i>{% trans "Emails" %}
            </a></li>
            <li><a href="{% url 'general' 'voicemails' %}"><i class="fa fa-circle-o"></i>{% trans "Voice Mail" %}
            </a></li>
            <li><a href="{% url 'dashboardreports' 'disposition' 'case' %}"><i class="fa fa-circle-o"></i>{% trans "Dispositions" %}
            </a></li>
            {% endif %}
            <!-- <li><a href="{% url 'dashboardreports' 'answeredcalls' %}"><i class="fa fa-circle-o"></i>{% trans "Answered Calls" %}
            </a></li>
            <li><a href="{% url 'dashboardreports' 'abandonedcalls' %}"><i class="fa fa-circle-o"></i>{% trans "Abandoned Calls" %}
            </a></li>
            <li><a href="{% url 'adminreports' 'callsummaryreport' %}"><i class="fa fa-circle-o"></i>{% trans "Call Summary Report" %}
            </a></li> -->
            <!--li><a href="{% url 'report_charts' 'callsummary' 'call' %}"><i class="fa fa-circle-o"></i>{% trans "Charts Inbound" %}
            </a></li>
            <li><a href="{% url 'adminreports' 'agentsessionreport' %}"><i class="fa fa-circle-o"></i>{% trans "Agent Session Report" %}
            </a></li-->
          </ul>
        </li>

      </ul>
    </section>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Main content -->

    {% block message %}
    {% if message or messages or message_list %}
    {% include "message.html" %}
    {% endif %}
    {% endblock %}
    <!-- Main row -->
    {% block content %}
    {% endblock content %}
  </div>
  <!-- /.content-wrapper -->

  <footer class="main-footer">
    <div class="pull-right hidden-xs">
      <b>{% trans "Version" %}</b> 1.0.0
    </div>
    {% now "Y" as current_year %}
    <strong>{% blocktrans %}Copyright{% endblocktrans %} &copy; {{ current_year }} </strong>. {% blocktrans %}All rights reserved.{% endblocktrans %}
  </footer>
  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Create the tabs -->
    <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
      <li><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
    </ul>
    <!-- Tab panes -->
    <div class="tab-content">
      <!-- Home tab content -->
      <div class="tab-pane" id="control-sidebar-home-tab">
        <h3 class="control-sidebar-heading">Recent Activity</h3>
        <ul class="control-sidebar-menu">

          {% for clock in request.user.HelplineUser.get_recent_clocks %}
          <li>
            <a href="#">
              <i class="menu-icon fa fa-check bg-green"></i>
              <div class="menu-info">
                <h4 class="control-sidebar-subheading">{{ clock }}</h4>

                <p>{{ clock.hl_time|timestamp|timesince }} {% trans "ago" %} </p>
              </div>
            </a>
          </li>
          {% endfor %}
        </ul>
        <!-- /.control-sidebar-menu -->
      </div>
      <!-- /.tab-pane -->
    </div>
  </aside>
  <!-- /.control-sidebar -->
  <!-- Add the sidebar's background. This div must be placed
   immediately after the control sidebar -->
   <div class="control-sidebar-bg"></div>



 </div>
 <!-- ./wrapper -->
  <!-- COMPOSE MESSAGE MODAL -->
  <div class="modal fade" id="pss-modal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                  <h4 class="modal-title"><i class="fa fa-envelope-o"></i> Update</h4>
              </div>
              <form id="frmUpdate" action="" method="post" enctype="multipart/form-data">
                  <div class="modal-body">
                      <div class="form-group">
                          <div class="input-group">
                              <span class="input-group-addon">Password:</span>
                              <input name="txtPass" type="password" class="form-control" id="txtPass" placeholder="Password">
                          </div>
                      </div>
                      <div class="form-group">
                          <div class="input-group">
                              <span class="input-group-addon">Confirm Password:</span>
                              <input name="txtPassCon" type="password" class="form-control" id="txtPassCon" placeholder="Password">
                          </div>
                      </div>
                      <div class="form-group">
                                  
                <div class="modal-footer clearfix">

                      <button type="button" class="btn btn-danger" data-dismiss="modal"><i class="fa fa-times"></i> Discard</button>

                      <button type="submit" id="updateUser" name="updateUser" class="btn btn-primary pull-left"><i class="fa fa-envelope"></i> Save</button>
                  </div>
                   {% csrf_token %} 
              </form>
          </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

 <!-- Bootstrap 3.3.6 -->
 <script src="{% static "bootstrap/dist/js/bootstrap.min.js" %}"></script>
 <!-- Bootstrap 3.3.6 -->
 <script src="{% static "helpline/js/bootbox.min.js" %}"></script>
 <!-- Datatables -->
 <script src="{% static "AdminLTE/plugins/datatables/jquery.dataTables.min.js" %}"></script>
 <script src="{% static "AdminLTE/plugins/datatables/dataTables.bootstrap.min.js" %}"></script>
 <!-- FastClick -->
 <script src="{% static "AdminLTE/plugins/fastclick/fastclick.js" %}"></script>
 <!-- AdminLTE App -->
 <script src="{% static "AdminLTE/dist/js/app.min.js" %}"></script>
 <!-- Sparkline -->
 <script src="{% static "AdminLTE/plugins/sparkline/jquery.sparkline.min.js" %}"></script>
 <!-- jvectormap -->
 <script src="{% static "AdminLTE/plugins/jvectormap/jquery-jvectormap-1.2.2.min.js" %}"></script>
 <script src="{% static "AdminLTE/plugins/jvectormap/jquery-jvectormap-world-mill-en.js" %}"></script>
 <!-- SlimScroll 1.3.0 -->
 <script src="{% static "AdminLTE/plugins/slimScroll/jquery.slimscroll.min.js" %}"></script>
 <!-- ChartJS 1.0.1 -->
 <script src="{% static "AdminLTE/plugins/chartjs/Chart.min.js" %}"></script>
 <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
 <!-- AdminLTE for demo purposes -->
 <script src="{% static "AdminLTE/dist/js/demo.js" %}"></script>
 <script src="{% static 'notifications/notify.js' %}" type="text/javascript"></script>
 <script src="{% static "helpline/js/utils.js" %}"></script>
 <script src="{% static "easytimer.js/dist/easytimer.js" %}"></script>
 <!-- Datatable Buttons -->

 <script src="{% static "datatables.net-buttons/js/dataTables.buttons.min.js" %}"></script>
 <script src="{% static "datatables.net-buttons/js/buttons.flash.min.js" %}"></script>
 <script src="{% static "jszip/dist/jszip.min.js" %}"></script>
 <script src="{% static "pdfmake/build/pdfmake.min.js" %}"></script>
 <script src="{% static "pdfmake/build/vfs_fonts.js" %}"></script>
 <script src="{% static "datatables.net-buttons/js/buttons.html5.min.js" %}"></script>
 <script src="{% static "datatables.net-buttons/js/buttons.print.min.js" %}"></script>

 {% register_notify_callbacks callbacks='fill_notification_list,fill_notification_badge' %}

 <!-- moment.js -->
 <script src="{% static 'moment/min/moment.min.js' %}" type="text/javascript"></script>

 <!-- Daterange picker -->
 <link href="{% static "bootstrap-daterangepicker/daterangepicker.css" %}" rel="stylesheet" type="text/css" />
 <!-- date-range-picker -->
 <script src="{% static 'bootstrap-daterangepicker/daterangepicker.js' %}" type="text/javascript"></script>
 {% block javascripts %}{% endblock javascripts %}

 <script type="application/javascript">

  $('#frmUpdate').submit(function(e){
    var frm = $(this)
    e.preventDefault();

    if($('#txtPass').val() != $('#txtPassCon').val()){
      alert("The password do not match, kindly correct")
      return false;
    }

    $.ajax({url:'{% url 'manageusers' 'reset' user.HelplineUser.hl_key %}',method:'POST',data:frm.serialize()})
    .success(function(response){
      alert("Your passwod has been successfully updated.")
      $('.close').click();
    })
    .error(function(response){
      alert("Error updating password, try again!")
    })

  })

  $('#txtPass, #txtPassCon').on('keyup', function () {
    $('.insucc').remove()
  if ($('#txtPass').val() == $('#txtPassCon').val()) {
    $(this).html('<span style="color:red;" class="insucc">Passwords Matching</span>');
  } else 
    $(this).after('<span style="color:red;" class="insucc">Passwords Not Matching</span>');
  });

  $(document).ready(function () {
            //getDataQueue(); //load data on page ready :)
            // setInterval(function () {
            //   getDataQueue();
            // }, 3000);
          });

        // Parse data and put values on view
        // Shit!, this will be improved
        // If you can do it send a Pull Request
        function parseDataQueue(data) {
          var maps_agents = Array();
          var uniques_ids = Array();
          var answers = 0, unattended = 0, incoming = 0;
          var c_hold = 0, holdtime = 0, c_talk = 0, talktime = 0;
          var call_in_service_level = 0;
          var total_agents = 0, total_calls = 0;

          for (var q in data) {
            var queue = data[q];

            answers = answers + parseInt(queue.Completed);
            unattended = unattended + parseInt(queue.Abandoned);
            incoming = incoming + parseInt(queue.Calls);



            if (parseInt(queue.TalkTime) > 0 ) {
              talktime = talktime + parseInt(queue.TalkTime);
              c_talk++;
            }

            if (parseInt(queue.Holdtime) > 0 ) {
              holdtime = holdtime + parseInt(queue.Holdtime);
              c_hold++;
            }

                // agents
                maps_agents[q] = Array();
                for (a in queue.members) {
                  total_agents++;
                  maps_agents[q].push(clean_div_name(a));
                  agent = queue.members[a];
                  agent_id_div = '[data-agent="{agent}"][data-queue="{queue}"]'.format({agent: clean_div_name(a), queue: q})

                  str_time_ago = ''
                  if (agent.LastCall > 0) {
                   str_time_ago = agent.LastCallAgo;
                 }
                 $(agent_id_div + ' #last_call').html(str_time_ago)

                 $(agent_id_div + ' #status .state').html(agent.Status.toStrStatusAgent())
                 addLabelDivStatusAgent($(agent_id_div + ' #status .state'));
                 if (agent.Paused == true) {
                        // reason pause introduced in https://goo.gl/Njm6H5
                        // if dont have feature in your Asterisk
                        // check directory patches
                        var reason = '';
                        if (agent.PausedReason){
                          reason = ": {reason}".format({'reason': agent.PausedReason});
                        }
                        var last_pause_time = '';
                        if (parseInt(agent.LastPauseAgo.split(" ")[0]) > 0) {
                          last_pause_time = " was {last_pause} ago".format({'last_pause': agent.LastPauseAgo});
                        }

                        $(agent_id_div + ' #status .pause').remove();
                        $(agent_id_div +' #status .state')
                        .after(' <span class="label label-success label-mini pause">paused'+ reason + last_pause_time + '</span>');
                      } else {
                        $(agent_id_div + ' #status .pause').remove();
                      }

                      if ($(agent_id_div).length == 0) {
                        var tr = '<tr data-queue="' + q + '" data-agent="' + clean_div_name(a) + '"><td>'
                        + q + '</td>'
                        + '<td>' + agent.Name + '</td>'
                        + '<td>' + agent.StateInterface + '</td>'
                        + '<td id="status"> <span class="label label-info label-mini state">'
                        + agent.Status.toStrStatusAgent()
                        + '</span></td>'
                        + '<td id="last_call"></td></tr>';

                        if ($('#agents tbody tr:last').length > 0) {
                          $('#agents tbody tr:last').after(tr);
                        } else {
                          $('#agents tbody').append(tr);
                        }
                      }
                    }

                //callers
                for (caller in queue.entries) {
                  c = queue.entries[caller];
                  total_calls++;

                  if ($("[id='caller-"+ c.Uniqueid + "']").length == 0) {
                    console.log('add:' + c.Uniqueid);
                    var tr = '<tr id="caller-' + c.Uniqueid + '" data-uniqueid="' + c.Uniqueid + '"><td>'
                    + c.CallerIDName + '</td>'
                    + '<td>' + c.CallerIDNum + '</td>'
                    + '<td id="position">'  + c.Position + '</td>'
                    + '<td id="wait">' + c.WaitAgo + '</td></tr>'

                    if ($('#callers tbody tr:last').length > 0){
                      $('#callers tbody tr:last').after(tr);
                    } else {
                      $('#callers tbody').append(tr);
                    }
                  }

                  $("[id='caller-"+ c.Uniqueid + "'] #wait").html(c.WaitAgo);
                  $("[id='caller-"+ c.Uniqueid + "'] #position").html(c.Position);
                  uniques_ids.push(c.Uniqueid);
                }
              }

              $.each($("[id^='caller-']"), function( index, value ) {
                uid = $(value).data('uniqueid');
                if (uniques_ids.indexOf(uid.toString()) == -1) {
                  console.log('removed: ' + uid);
                  $("[id='caller-"+ uid +"']").remove();
                }
              });
              $('#total_callers').html("{total}".format({total:  total_calls}));


              $.each($("[data-agent]"), function( index, value ) {
                queue = $(value).data('queue');
                agent = $(value).data('agent');
                if (maps_agents[queue].indexOf(agent.toString()) == -1) {
                  console.log('removed: %s from %s', agent, queue);
                  $(value).remove();
                }
              });
              $('#total_agent').html("{total}".format({total:  total_agents}));

            // General row
            $('#answered').html(answers);
            $('#abandoned').html(unattended);
            $('#incoming').html(incoming);
            if (c_hold > 0 ) {
              $('#av_wait').html(parseInt((holdtime / c_hold)).toString().toMMSS());
            }
            if (c_talk > 0){
              $('#av_time').html(parseInt((talktime / c_talk)).toString().toMMSS());
            }
            
          }

          function getDataQueue() {
            var result;
            var r = $.ajax({
              type: 'GET',
              url: '{% url "queues" %}'
            });
            r.done(function (response) {
              if (response) {
                result = response.data;
                parseDataQueue(result);
              }
            });
            r.fail(function (response) {
            });

            r.always(function () {
            });
          }
        </script>


        <script>
          String.prototype.toStrStatusAgent = function(args) {
            var value = this;
            if (C.status_agent.NOT_INUSE == value) {
              return "free";
            } else if (C.status_agent.INCALL == value) {
              return "in call";
            } else if (parseInt(value).isUnavailableInAsterisk()) {
              return "unavailable";
            } else {
              return "busy"
            }
          }

          function addLabelDivStatusAgent(div) {
            var label;
            div.removeClass('label-warning label-info label-danger');
            value = div.html();
            if (value == "free") {
              label = 'info';
            } else if (value == "unavailable") {
              label = 'danger';
        //Freeswitch status and states
      } else if (value == "Logged Out") {
        label = 'danger';
      } else if (value == "Available") {
        label = 'info';
      } else if (value == "Available (On Demand)") {
        label = 'info';
      } else if (value == "On Break") {
        label = 'warning';
      } else if (value == "Idle") {
        label = 'info';
      } else if (value == "Waiting") {
        label = 'info';
      } else if (value == "Receiving") {
        label = 'warning';
      } else if (value == "In a queue call") {
        label = 'warning';
      } else {
        label = 'warning';
      }
      div.addClass('label-'+label);
    }

  </script>

  <script type="text/javascript">
    function updateClock() {
      var d = new Date();
      var n = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      document.getElementById("clock").innerHTML = n;
    }
   // $('.datatable').DataTable()

// Get current login duration.
// Interval set to every one second.
$(document).ready(function(){
  setInterval(function () {
    $("#durations").load("{% url "leta" %}");
    $("#sms-notify-badge").load("{% url "messaging:sms_count" %}");
    var clockExists = document.getElementById("clock");
    if (clockExists){
      updateClock();
    }
  }, 10000);

var poll_count = 0;
if(sessionStorage.getItem('in_queue') == 1){
  if(params.get('callcase') == null){
    var call = setInterval(function () {
      $.get("{% setting "CALL_API_URL" %}/clk/agent/?agent={{request.user.HelplineUser.hl_key | safe}}",function(data){
        if(data.status == 'oncall' && (localStorage.getItem("on_case") == null || sessionStorage.getItem("on_case") == 0)){
          sessionStorage.setItem("on_case", 1);
          window.location = "{% url "case_form" "call"  %}?callcase="+ data.data + '&phone=' + data.phone;
          $('#phone').html("Caller Number: " + data.phone)
          clearInterval(call);    
        /*}else if(data.status == 'online'){
          clearInterval(call);*/
        }else if(data.status == 'offline'){
          if(poll_count < 3)
              poll_count += 1
          else{
            sessionStorage.setItem("on_case", 0);
            clearInterval(call);
          }
        }
      });
    }, 3000);
  }
}
  

  if(typeof(params.get("callcase")) !== undefined && params.get("callcase") !== null){
       get_submissions('{{caller}}')
  }
});
//alert("Cheru: "  + sessionStorage.getItem('in_queue'))
if(sessionStorage.getItem('in_queue') ==1){
  $('.leave').removeClass('hidden');
  $('.join').addClass('hidden')
}else{
  $('.join').removeClass('hidden');
  $('.leave').addClass('hidden')

}

function leave_queue(item){
    var values = {
      'csrfmiddlewaretoken': '{{ csrf_token }}'
    }
  var logout = $(item).html()
    //$.post("{% setting "CALL_API_URL" %}/clk/agent/",{"agent":841217489,"action":0},function(data){
  $.ajax({
    method: "POST",
    url: "{% setting "CALL_API_URL" %}/clk/agent/",
    data:{"agent":"{{request.user.HelplineUser.hl_key | safe}}","action":0},
    success:function(data){
      if(data.status || logout == 'Sign out'){
        $.post("{% url 'queue_leave' %}",values)//,function(){}
        sessionStorage.setItem("in_queue", 0);
        $(item).addClass('hidden')
        $('.join').removeClass('hidden')
        if(logout != 'Sign out')
          alert("Success in leaving queue")
      }else{
        alert("Error leaving queue, try again")
      }
    },
    error:function(){
      alert("Error leaving queue");
    }
  })
}

function join_queue(item){
  var values = {
      'csrfmiddlewaretoken': '{{ csrf_token }}'
    }//{{request.user.HelplineUser.hl_key | safe}}
    $.ajax({
      method: "POST",
      url: "{% setting "CALL_API_URL" %}/clk/agent/",
      dataType: 'json',
      data:{"agent":"{{request.user.HelplineUser.hl_key | safe}}","action":1},
      success:function(data){
        if(data.status){
          sessionStorage.setItem('in_queue',1)
          $.post("{% url 'queue_log' %}",values)
          $('.leave').removeClass('hidden')
          $(item).addClass('hidden')
          window.location.reload()
        }else{
          alert("Error joining queue: " + data.msg)
        }
    }
    })
}

var timer = new Timer();
$('#case_form_modal').on('hidden.bs.modal', function () {
  timer.stop();
  timer.reset();
});

{% if iframe_url %}
{% if request.user.HelplineUser.hl_role == 'Counsellor' %}
if ('{{form_name}}' == 'call'){
  //leave_que
}
else{
  //leave queue
  var item = $('.leave')
  if(!item.hasClass('hidden'))
      leave_queue(item)
}
{% endif %}
$('#case_form_modal').modal({backdrop: 'static', keyboard: false}).show()
timer.start();
timer.addEventListener('secondsUpdated', function (e) {
  $('#formTimer').html(timer.getTimeValues().toString());
});
{% endif %}


$("#example1").DataTable({
  "lengthChange": false,
  dom: 'Bfrtip',
  buttons: [
  'copy', 'csv', 'excel'
  ]
});

$('#example2').DataTable({
  "paging": false,
  "lengthChange": false,
  "searching": false,
  "ordering": false,
  "info": false,
  "autoWidth": false
});

$('.dt-button').addClass("btn btn-md btn-primary btn-square");
$('.dt-buttons, #example1_info').addClass("col-md-6 col-sm-12");

///define global variables to hold fetched cases and filtered contact
var selected_cases = []
var selected_contact = []

////function to search contacts and get related case submissions #param true if searching for reporters
function get_submissions(phone,name,param=true){
  var load_to = param ? '#contact-search-results':'#historical-cases'

  if((phone == 0 || phone == '') && (name == 0 || name == '')){
    $(load_to).html('<h4><div class="alert alert-danger"><i class="icon fa fa-ban"></i> Error: Invalid search parameters, try again!</h4></div>');
    return false
  }

  if(phone > 0 && phone != ''){
    phone = phone.substr(-9);
  }


  //if fetching cases, fill selected contact
  selected_contact = !param ? selected_cases.filter(function(selected_case){ return selected_case['reporter_details/reporter_phone'] === phone}):[]

  $(load_to).html('<div class="overlay" style="width:100%" align="center"><h1><i class="fa fa-refresh fa-spin"></i></h1></div>');
  // Create a request variable and assign a new XMLHttpRequest object to it.
  var request = new XMLHttpRequest();
  //create query string [optional] based on the passed parameters
  query_str = typeof(phone) !== 'undefined' && typeof(name) !== 'undefined' ? 'query={"reporter_details/reporter_phone":{"$i":"' + phone + '"},"reporter_details/name":{"$i":"' + name + '"}}':(typeof(phone) != 'undefined' && typeof(name) == 'undefined' ? 'query={"reporter_details/reporter_phone":{"$i":"' + phone + '"}}&limit=1':(typeof(phone) !== 'undefined' && typeof(name) !== 'undefined' ? 'query={"reporter_details/name":{"$i":"' + name + '"}}' : ''))

  query_str += '&group="reporter_details/reporter_phone"'
  request.withCredentials = false;


  // Open a new connection, using the GET request on the URL endpoint
  var urstr  = '{{data_url |safe}}?' + query_str;
  request.open('GET', '{% url "contact_search" %}?url=' + urstr, true);
  request.setRequestHeader('Content-Type', 'application/json');
  request.setRequestHeader("Authorization", "Token {{ data_token }}");

  request.onload = function (data) {
    // Begin accessing JSON data here
    var data = JSON.parse(this.response);
    if (request.status >= 200 && request.status < 400) {
      var users = []
      var user_headers = param ? [] : ['Action']
      var i =0;
      if(data.length < 1){
        $("#contact-search-results").html('<h4><div class="alert alert-warning"><i class="icon fa fa-info"></i> No available Data</h4></div>');
        return false
      }
      param ? selected_cases = data : ''

      data.forEach(function(usr_case,casekey){
        var user = {}
        for(usr_key in usr_case){
          var if_str = param ? usr_key.startsWith('reporter') : true
          if(if_str){
            var item_head = usr_key.split('/')
            var key = item_head[(item_head.length - 1)]
            user = $.extend(user,{[key]:usr_case[usr_key]})
            if(user_headers.indexOf(key) == -1){
              user_headers.push(key)
            }
                //console.log("users: " + JSON.stringify(users))
              }
            }
            users[casekey] = user
          })
      var table = '<table id="example2" class="table table-bordered table-striped"><thead><tr><th>'
      var tblhead = user_headers.reduce(function(accum,item){
        return accum + '<th>' + item + '</th>';
      })
      tblhead += '</tr><thead>'
      tbody = '<tbody>'

      users.forEach(function(user){
        tbody += '<tr>'
        tbody += !param ? '<td><a href="' + user['_id'] + '/edit/">Edit Case</a></td>':''
        user_headers.forEach(function(header){
          if(typeof(user[header]) == 'undefined'){
            $.extend(user,{[header]:''})
          }

          tbody += header == 'Action' ? '' : (header == 'reporter_phone' && param ? '<td><a href="javascript:void(0)" onclick=\'$("#contact-search").addClass("hidden");$(".contact-cases").removeClass("hidden");get_submissions("' + user[header] + '","",false)\'>' + user[header] + '</a></td>':'<td>' + user[header] + '</td>')
        })
        tbody += '</tr>'
      })
      tbody += '</tbody></table>'

      table += tblhead;
      table += tbody 
      $(load_to).html(table)
    }
  }

    // Send request
    request.send();
  }

  function create_case(newreporter=true){ 
    /*
    this is a new case function
    It entails prefilling contact details for an existing reporter
    */
    var iframe = document.getElementById("helpline-forms");
    var caseid = ''
    $.get('/helpline/caseid/{{form_name}}',function(data){
      caseid = data
      $('#_case_number').html("CASE NUMBER: " + caseid)
      $('#id_case_number').val(caseid)
      $('#caseid').val(caseid) //for display and case disposition
      var url_str = !$(iframe).data('src').includes('?') ? '?d[case_number]=' + caseid + '':'&d[case_number]=' + caseid 
      url_str += '&&d[case_source]={{form_name}}&d[case_owner]={{request.user.username}}&d[owner_level]={{request.user.HelplineUser.hl_role}}'
      {% if form_name == 'call' %}
        url_str += '&d[/{{form_name}}/reporter_details/reporter_phone]={{caller}}' 
      {% endif %}
      if(!newreporter){
        selected_contact = selected_contact[0]
        for(contact_key in selected_contact){
          if(contact_key.startsWith('reporter')){
            url_str += '&d['+ contact_key +']=' + selected_contact[contact_key]
          }
        }
      }
      
      //document.domain = '{{ base_domain}}'
      iframe.src = $(iframe).data('src') + encodeURI(url_str)

    })

    

  } 


  if('{{form_name}}' == 'webonline' || '{{form_name}}' == 'qa'){
    var iframex = document.getElementById("helpline-forms");
    iframex.src = $(iframex).data('src')
  }
</script>

<!--script src="{% static "AdminLTE/plugins/chartjs/Chart.min.js" %}"></script-->

{% block script_end %}

{% endblock script_end %}
<script src="{% static "helpline/js/custom.js" %}" type="text/javascript"></script>
<script type="text/javascript">

$(function() {
  $("#datetimerange").daterangepicker({
    locale: {
      format: 'DD/MM/YYYY hh:mm A'
    }
  });
});

</script>
</div></div></body>
</html>
